# TASKS: Two-Stage AI Code Generation Workflow

## CURRENT TASK CONTEXT
**Task ID**: AI-CODEGEN-001
**Task Type**: Feature Enhancement
**Mode**: Development
**Priority**: High
**Status**: IN PROGRESS - Subtasks 9.1, 9.2 & 9.3 Complete
**Created**: 2025-01-20
**Assigned**: AI Assistant

## TASK DESCRIPTION
**Objective**: Implement a two-stage AI model workflow for enhanced code generation in developer mode
**Scope**: Use vercelModel for initial React code generation, then refine with Claude for Weaverse best practices

**Background**: Current code generation uses a single model. By leveraging vercelModel's strength in React/UI generation and Claude's understanding of Weaverse patterns, we can produce higher quality component code.

## IMPLEMENTATION PROGRESS

### ✅ Completed: Subtask 9.1 - Integrate vercelModel API
**Status**: DONE
**Key Changes**:
- Updated `image-provider.ts` to load and use `image-to-section.md` prompt
- Added system prompt to vercelModel's generateText call
- Implemented proper error handling and logging
- Added fallback prompt for robustness
- Set temperature=0 and maxTokens=4000 for consistent output

### ✅ Completed: Subtask 9.2 - Integrate Claude API for Code Refinement
**Status**: DONE
**Key Changes**:
- Created `claude-refinement.md` prompt specifically for refinement stage
- Updated `streamWeaverseCode` to detect refinement stage automatically
- Added intelligent prompt selection based on message context
- Maintained backward compatibility with existing workflow
- **Enhanced with Tailwind CSS v4 requirements**:
  - Critical styling guidelines (important modifiers at beginning: `!text-red-500`)
  - Modern Tailwind v4 syntax and configuration options
  - Validation against Tailwind v4 requirements
  - Leverage new v4 features (container queries, color spaces)
  - Responsive design with proper breakpoint usage

### ✅ Completed: Subtask 9.3 - Develop Two-Stage Workflow Logic
**Status**: DONE
**Key Changes**:
- Created `TwoStageWorkflowOrchestrator` class for robust workflow management
- Implemented comprehensive error handling with custom error types
- Added retry logic with exponential backoff (1s, 2s, 4s delays)
- Built-in fallback mechanism to single-stage if two-stage fails
- Progress tracking callbacks for UI feedback
- React code validation between stages
- Configurable workflow options (enable/disable, retry attempts, fallback)
- Enhanced `handleImageToSectionNew` to use orchestrator
- Maintains backward compatibility with existing API

**Key Findings**:
- Claude integration was already functional in `streamWeaverseCode`
- Two-stage workflow confirmed and optimized:
  - Stage 1: vercelModel generates React code with image-to-section.md prompt
  - Stage 2: Claude refines with claude-refinement.md prompt for Weaverse best practices + Tailwind CSS v4
- Automatic detection of refinement stage based on message patterns
- Production-ready workflow with robust error handling

## STYLING REQUIREMENTS
**CRITICAL**: This project uses **Tailwind CSS v4**. All generated code must follow v4-specific syntax:
- Important modifiers: `!text-red-500` (NOT `text-red-500!`)
- Modern v4 features: container queries, color spaces
- Proper responsive design patterns
- Semantic class combinations

## NEXT STEPS
- **Subtask 9.4**: Update Developer Mode UI for Two-Stage Workflow (PENDING)
- Continue implementing remaining subtasks

## TASKMASTER TASK STRUCTURE

### Task 9: Implement Two-Stage AI Model Workflow for Code Generation (ID: 9)
**Status**: IN-PROGRESS  
**Priority**: High
**Dependencies**: [7, 8]

#### Subtasks:
1. **Integrate vercelModel API for Initial React Code Generation** (9.1) ✅ DONE
   - Set up and configure the vercelModel (v0-1.5-md) API to generate initial React code from image inputs or prompts.
   - Implementation: Updated image-provider.ts to use image-to-section.md prompt

2. **Integrate Claude API for Code Refinement** (9.2) ✅ DONE
   - Configure Claude (default model) to refine the React code generated by vercelModel, focusing on Weaverse-specific patterns and best practices.
   - Implementation: Created claude-refinement.md prompt with Tailwind CSS v4 requirements, updated streamWeaverseCode for intelligent prompt selection

3. **Develop Two-Stage Workflow Logic** (9.3) ✅ DONE
   - Orchestrate model handoff, implement error handling and retries, manage data flow between models.
   - Implementation: Created TwoStageWorkflowOrchestrator with comprehensive error handling, retry logic, and fallback mechanisms

4. **Update Developer Mode UI for Two-Stage Workflow** (9.4) - PENDING
   - Add feature toggle for two-stage mode, implement progress indicators, integrate with existing chat interface.

5. **Optimize with Caching and Parallel Processing** (9.5) - PENDING
   - Implement result caching, enable parallel processing where possible, reduce redundant API calls.

6. **Document Workflow and Examples** (9.6) - PENDING
   - Create usage documentation, provide example prompts and outputs, document best practices.

## MEMORY BANK UPDATE
Created memory: "When in AI dev mode and the user requests code generation, use the vercelModel for initial code generation with @image-to-section.md as the prompt, then run through the default model (Claude) for a complete result, ensuring strict adherence to Weaverse component structure and best practices." (ID: 3256269358268751974)

## IMPLEMENTATION CHECKLIST

### Phase 1: Model Integration
- [ ] Configure vercelModel API access
- [ ] Test vercelModel with image-to-section.md prompt
- [ ] Set up Claude API refinement pipeline
- [ ] Validate model switching mechanism
- [ ] Test error recovery between models

### Phase 2: Workflow Development
- [ ] Create orchestration layer for model handoff
- [ ] Implement prompt templates for each stage
- [ ] Design error handling strategy
- [ ] Build retry logic with exponential backoff
- [ ] Test edge cases (timeouts, API failures)

### Phase 3: UI Enhancement
- [ ] Design two-stage progress indicators
- [ ] Add feature toggle in developer mode
- [ ] Update chat interface for new workflow
- [ ] Implement stage-specific feedback
- [ ] Test UI responsiveness during processing

### Phase 4: Performance Optimization
- [ ] Implement intelligent caching layer
- [ ] Identify parallelization opportunities
- [ ] Optimize prompt sizes and API calls
- [ ] Add performance monitoring
- [ ] Benchmark against single-model approach

## TECHNICAL ARCHITECTURE

### Model Pipeline
```
User Input (Image/Prompt)
    ↓
[Stage 1: vercelModel]
    - Purpose: Generate initial React code
    - Prompt: image-to-section.md
    - Strength: UI/React understanding
    ↓
[Intermediate Processing]
    - Extract generated code
    - Prepare for refinement
    ↓
[Stage 2: Claude]
    - Purpose: Refine for Weaverse
    - Focus: Component structure, best practices
    - Strength: Weaverse patterns
    ↓
Final Weaverse Component
```

### Key Integration Points
1. **image-to-section.ts** - Main orchestration
2. **providers/image-provider.ts** - vercelModel integration
3. **model.ts** - Model switching logic
4. **provider.ts** - Claude refinement stage

## SUCCESS CRITERIA
- [ ] Two-stage workflow successfully generates components
- [ ] vercelModel produces valid initial React code
- [ ] Claude refinement ensures Weaverse compliance
- [ ] Performance within acceptable limits (< 10s total)
- [ ] Error handling covers all failure scenarios
- [ ] UI provides clear stage feedback
- [ ] Documentation enables easy adoption

## BLOCKERS/DEPENDENCIES
**Current Blockers**: None
**Dependencies**: 
- Existing AI infrastructure
- vercelModel API access
- Claude API access
- image-to-section.md prompt

## NOTES
- vercelModel excels at UI/React generation from visual inputs
- Claude ensures strict Weaverse component patterns
- Two-stage approach balances quality with performance
- Consider fallback to single-model if either stage fails
- Monitor API usage to manage costs

## PREVIOUS COMPLETED PROJECT
The Upload Image Optimization project (tasks 1-8) has been successfully implemented, with only final testing remaining. 